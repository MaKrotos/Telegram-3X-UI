# Система состояний пользователей

## Обзор

Система состояний пользователей позволяет управлять статусом пользователей в Telegram-3X-UI, отслеживать их активность и контролировать доступ к функциям системы.

## Состояния пользователей

### Доступные состояния

1. **active** - Активный пользователь
   - Полный доступ к системе
   - Может управлять своими XUI серверами
   - Может создавать и настраивать VPN соединения

2. **inactive** - Неактивный пользователь
   - Ограниченный доступ
   - Не может создавать новые соединения
   - Может просматривать существующие

3. **blocked** - Заблокированный пользователь
   - Полный запрет доступа
   - Не может использовать систему
   - Требует обращения в поддержку

4. **pending_verification** - Ожидает верификации
   - Ограниченный доступ до верификации
   - Не может создавать новые серверы
   - Может просматривать существующие

5. **suspended** - Временно приостановлен
   - Временный запрет доступа
   - Автоматическая активация по истечении срока
   - Может быть продлен администратором

6. **deleted** - Удаленный пользователь
   - Полный запрет доступа
   - Данные сохраняются для аудита
   - Не может быть восстановлен автоматически

## Ожидаемые действия

### Типы ожидаемых действий

1. **none** - Ничего не ожидается
   - Пользователь может использовать систему нормально

2. **verify_email** - Ожидается верификация email
   - Пользователь должен подтвердить email
   - Ограниченный доступ до верификации

3. **complete_profile** - Ожидается заполнение профиля
   - Пользователь должен дополнить информацию профиля
   - Необходимо для полного доступа

4. **add_payment** - Ожидается добавление платежа
   - Пользователь должен добавить способ оплаты
   - Требуется для премиум функций

5. **contact_support** - Ожидается обращение в поддержку
   - Пользователь должен связаться с поддержкой
   - Обычно после блокировки или проблем

6. **wait_approval** - Ожидается одобрение администратора
   - Пользователь ждет одобрения заявки
   - Временный доступ ограничен

## API Endpoints

### Получение состояния пользователя

```http
GET /api/users/{telegram_id}/state
```

**Права доступа:**
- Пользователь может видеть только свое состояние
- Администратор может видеть любое состояние

**Ответ:**
```json
{
  "id": 1,
  "telegram_id": 123456789,
  "username": "user123",
  "first_name": "Иван",
  "last_name": "Иванов",
  "state": "active",
  "expected_action": "none",
  "state_changed_at": "2024-01-15T10:30:00Z",
  "state_reason": "Пользователь активирован",
  "state_changed_by_tg_id": 987654321,
  "state_changed_by_username": "admin",
  "state_expires_at": null,
  "state_metadata": {
    "activated_at": 1705312200
  },
  "created_at": "2024-01-15T10:00:00Z",
  "updated_at": "2024-01-15T10:30:00Z",
  "last_activity": "2024-01-15T12:00:00Z"
}
```

### Обновление состояния пользователя

```http
PUT /api/users/{telegram_id}/state
```

**Права доступа:** Только администраторы

**Тело запроса:**
```json
{
  "new_state": "blocked",
  "expected_action": "contact_support",
  "reason": "Нарушение правил использования",
  "expires_at": "2024-02-15T10:30:00Z",
  "metadata": {
    "block_reason": "Нарушение правил использования",
    "blocked_at": 1705312200
  }
}
```

### Получение пользователей по состоянию

```http
GET /api/users/state/{state}?limit=50&offset=0
```

**Права доступа:** Только администраторы

**Параметры:**
- `state` - состояние пользователей (active, inactive, blocked, etc.)
- `limit` - количество записей (1-100, по умолчанию 50)
- `offset` - смещение для пагинации

### Получение пользователей по ожидаемому действию

```http
GET /api/users/action/{action}?limit=50&offset=0
```

**Права доступа:** Только администраторы

**Параметры:**
- `action` - ожидаемое действие (none, verify_email, etc.)
- `limit` - количество записей (1-100, по умолчанию 50)
- `offset` - смещение для пагинации

### Получение пользователей с истекшими состояниями

```http
GET /api/users/expired-states
```

**Права доступа:** Только администраторы

**Ответ:** Список пользователей с истекшими временными состояниями

### Получение статистики состояний

```http
GET /api/users/state-statistics
```

**Права доступа:** Только администраторы

**Ответ:**
```json
{
  "total_users": 150,
  "by_state": {
    "active": 120,
    "inactive": 15,
    "blocked": 5,
    "pending_verification": 8,
    "suspended": 2
  },
  "by_action": {
    "none": 120,
    "verify_email": 8,
    "contact_support": 7,
    "complete_profile": 10,
    "add_payment": 5
  },
  "combinations": {
    "active_none": 120,
    "pending_verification_verify_email": 8,
    "blocked_contact_support": 5
  }
}
```

### Блокировка пользователя

```http
POST /api/users/{telegram_id}/block
```

**Права доступа:** Только администраторы

**Тело запроса:**
```json
{
  "reason": "Нарушение правил использования"
}
```

### Активация пользователя

```http
POST /api/users/{telegram_id}/activate
```

**Права доступа:** Только администраторы

**Тело запроса:**
```json
{
  "reason": "Пользователь восстановлен"
}
```

### Приостановка пользователя

```http
POST /api/users/{telegram_id}/suspend
```

**Права доступа:** Только администраторы

**Тело запроса:**
```json
{
  "reason": "Временное нарушение",
  "duration": "24h"
}
```

**Поддерживаемые форматы длительности:**
- `24h` - 24 часа
- `7d` - 7 дней
- `30m` - 30 минут
- `1w` - 1 неделя

### Запрос верификации пользователя

```http
POST /api/users/{telegram_id}/request-verification
```

**Права доступа:** Только администраторы

**Тело запроса:**
```json
{
  "reason": "Требуется подтверждение email"
}
```

### Проверка прав пользователя

```http
GET /api/users/{telegram_id}/permission
```

**Права доступа:**
- Пользователь может проверять только свои права
- Администратор может проверять любые права

**Ответ:**
```json
{
  "can_perform": true,
  "reason": ""
}
```

## Использование в коде

### Инициализация сервиса

```go
import "Telegram-3X-UI/internal/services"

// Создание сервиса состояний
userStateService := services.NewUserStateService(db)

// Создание обработчика
userStateHandler := handlers.NewUserStateHandler(userStateService, adminService)
```

### Проверка активности пользователя

```go
// Проверка, активен ли пользователь
isActive, err := userStateService.IsUserActive(telegramID)
if err != nil {
    // Обработка ошибки
}

if !isActive {
    // Пользователь неактивен
    return
}
```

### Проверка прав на выполнение действий

```go
// Проверка прав пользователя
canPerform, reason, err := userStateService.CanUserPerformAction(telegramID)
if err != nil {
    // Обработка ошибки
}

if !canPerform {
    // Пользователь не может выполнять действия
    // reason содержит причину
    return
}
```

### Изменение состояния пользователя

```go
// Блокировка пользователя
err := userStateService.BlockUser(
    telegramID,
    "Нарушение правил",
    adminTgID,
    "admin_username",
)

// Активация пользователя
err := userStateService.ActivateUser(
    telegramID,
    adminTgID,
    "admin_username",
)

// Приостановка пользователя
err := userStateService.SuspendUser(
    telegramID,
    "Временное нарушение",
    24*time.Hour,
    adminTgID,
    "admin_username",
)
```

## Автоматические действия

### Обработка истекших состояний

Система автоматически обрабатывает истекшие временные состояния:

1. **Приостановленные пользователи** - автоматически активируются по истечении срока
2. **Временные блокировки** - снимаются автоматически
3. **Ожидающие верификации** - могут быть автоматически деактивированы

### Рекомендуемая настройка cron-задачи

```bash
# Проверка истекших состояний каждые 5 минут
*/5 * * * * /path/to/your/app check-expired-states
```

## Безопасность

### Рекомендации по безопасности

1. **Логирование изменений** - все изменения состояний логируются с указанием администратора
2. **Аудит доступа** - ведется история изменений состояний
3. **Ограничение прав** - только администраторы могут изменять состояния
4. **Валидация данных** - все входные данные валидируются
5. **Метаданные** - дополнительная информация сохраняется в JSON формате

### Метаданные состояний

Каждое изменение состояния может включать метаданные:

```json
{
  "blocked_at": 1705312200,
  "block_reason": "Нарушение правил",
  "admin_note": "Повторное нарушение",
  "ip_address": "192.168.1.100",
  "user_agent": "TelegramBot/1.0"
}
```

## Мониторинг и уведомления

### Рекомендуемые метрики

1. **Количество пользователей по состояниям**
2. **Время нахождения в каждом состоянии**
3. **Частота изменений состояний**
4. **Количество истекших состояний**

### Уведомления

Рекомендуется настроить уведомления для:

1. **Новых блокировок** - уведомление администраторов
2. **Истекших приостановок** - автоматическое уведомление пользователей
3. **Требующих верификации** - напоминания пользователям
4. **Статистики состояний** - еженедельные отчеты

## Миграция данных

### Добавление состояний к существующим пользователям

При применении миграции все существующие пользователи получают состояние `active` по умолчанию.

### Обновление существующих записей

```sql
-- Установка состояния active для всех существующих пользователей
UPDATE telegram_users 
SET state = 'active', 
    expected_action = 'none',
    state_changed_at = CURRENT_TIMESTAMP
WHERE state IS NULL;
```

## Примеры использования

### Telegram Bot интеграция

```go
// В Telegram боте
func handleUserCommand(bot *tgbotapi.BotAPI, update tgbotapi.Update) {
    userID := update.Message.From.ID
    
    // Проверяем права пользователя
    canPerform, reason, err := userStateService.CanUserPerformAction(int64(userID))
    if err != nil {
        // Обработка ошибки
        return
    }
    
    if !canPerform {
        // Отправляем сообщение о причине ограничения
        msg := tgbotapi.NewMessage(update.Message.Chat.ID, 
            fmt.Sprintf("Доступ ограничен: %s", reason))
        bot.Send(msg)
        return
    }
    
    // Выполняем команду
    // ...
}
```

### Middleware для HTTP API

```go
func userStateMiddleware(userStateService *services.UserStateService) func(http.Handler) http.Handler {
    return func(next http.Handler) http.Handler {
        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
            userTgID := getUserTelegramID(r)
            if userTgID == 0 {
                http.Error(w, "Не авторизован", http.StatusUnauthorized)
                return
            }
            
            canPerform, reason, err := userStateService.CanUserPerformAction(userTgID)
            if err != nil {
                http.Error(w, "Ошибка проверки прав", http.StatusInternalServerError)
                return
            }
            
            if !canPerform {
                http.Error(w, fmt.Sprintf("Доступ ограничен: %s", reason), http.StatusForbidden)
                return
            }
            
            next.ServeHTTP(w, r)
        })
    }
}
``` 